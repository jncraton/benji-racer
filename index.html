<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Benji Racer</title>

<style>
body {
  margin:0 auto;
  padding:0;
  width:640px;
}
canvas {
  border:1px solid #ccc;
}
</style>

</head>
<body>
</body>

<script>
//https://jlongster.com/Making-Sprite-based-Games-with-Canvas

var race_state = {}
var imgs = {}

function is_track_pathable(x, y) {
  let track = imgs[race_state.track]

  var canvas = document.createElement('canvas');
  canvas.width = track.width;
  canvas.height = track.height;
  canvas.getContext('2d').drawImage(track, 0, 0, track.width, track.height);

  return !!canvas.getContext('2d').getImageData(x, y, 1, 1).data[0];
}

async function load_img(filename) {
  return new Promise(resolve => {
    var img = new Image()
    img.onload = function() {
        imgs[filename] = img
        console.log(filename + ' loaded')
        resolve(img)
    }
    img.src = filename
  });
}

function update(dt) {
  race_state.x = race_state.x + 200 * dt

  for (var y=0; y<240; y++) {
    if (!is_track_pathable(race_state.x,y)) break;
  }

  race_state.y = y
} 

var lastTime = Date.now();
function main() {
    var now = Date.now();
    var dt = (now - lastTime) / 1000.0;

    update(dt);
    render();

    lastTime = now;
    requestAnimationFrame(main);
};

async function init() {
  const canvas = document.createElement("canvas")
  const ctx = canvas.getContext("2d")
  canvas.width = 640
  canvas.height = 480
  ctx.scale(2,2)
  document.body.appendChild(canvas)

  race_state.x = 0
  race_state.track = 'assets/tracks/1.png'

  await load_img(race_state.track)

  main()
}

function render() {
  const canvas = document.querySelector('canvas');
  const ctx = canvas.getContext('2d');

  let track = imgs['assets/tracks/1.png']
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

  ctx.drawImage(track, -race_state.x, 0)
}

init()

</script>

</html>