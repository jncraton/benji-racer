<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Benji Racer</title>

<style>
body {
  margin:0 auto;
  padding:0;
  max-width:960px;
}
canvas {
  width:100%;
}
img {
  height:64px;
}

#race {
  display:none;
}
</style>

</head>
<body>
<section id="start">
<img src="assets/cars/2.png">
<img src="assets/cars/3.png">
<img src="assets/cars/4.png">
<img src="assets/cars/5.png">

<button id="start">Start</button>
</section>

<section id="race">
<canvas></canvas>
</section>


<div id=log></div>
</body>

<script>
var debug = false

function log(msg) {
  if (debug) { 
    document.querySelector('#log').innerHTML=msg
  }
}

var race_state = {}
var imgs = {}

function get_track_top(x) {
  x = x % race_state.track.width

  col = race_state.track_canvas.getContext('2d').getImageData(x, 1, 1, 240).data

  for (var y=0; y<240; y++) {
    if (col[y*4] < 240 && col[y*4 + 1] < 240 && col[y*4 + 2] < 240) return y
  }

  return 300
}

async function load_img(filename) {
  return new Promise(resolve => {
    var img = new Image()
    img.onload = function() {
        imgs[filename] = img
        console.log(filename + ' loaded')
        resolve(img)
    }
    img.src = filename
  });
}

function update(dt) {
  race_state.dx = Math.min(500, race_state.dx)
  race_state.x = race_state.x + race_state.dx * dt
  race_state.dx -= 30 * dt
  race_state.dx = Math.max(0, race_state.dx)

  let car_height = 32
  let car_width = 64
  let xfuzz = car_width / 4

  floor = Math.min(get_track_top(race_state.x + xfuzz) - car_height,
                   get_track_top(race_state.x + car_width - xfuzz) - car_height)

  if (race_state.y > floor) {
    race_state.dy = 50 * (floor - race_state.y) * dt
    race_state.y = floor
  } else {
    race_state.dy += 200 * dt
    race_state.y += race_state.dy * dt
  }

  log('<p>x:' + race_state.x +'<p>y:' + race_state.y + '<p>dx:' + race_state.dx+ '<p>dy:' + race_state.dy)
} 

var lastTime = Date.now();
function main() {
    var now = Date.now();
    var dt = (now - lastTime) / 1000.0;

    update(dt);
    render();

    lastTime = now;
    requestAnimationFrame(main);
};

async function init() {
  const canvas = document.querySelector('canvas')
  const ctx = canvas.getContext("2d")
  canvas.width = 640
  canvas.height = 480
  ctx.scale(2,2)

  race_state.x = 0
  race_state.y = 0
  race_state.dx = 200
  race_state.dy = 0
  race_state.track = await load_img('assets/tracks/1.png')
  race_state.car = await load_img('assets/cars/3.png')

  race_state.track_canvas = document.createElement('canvas')
  race_state.track_canvas.width = race_state.track.width
  race_state.track_canvas.height = race_state.track.height
  race_state.track_canvas.getContext('2d').drawImage(race_state.track, 0, 0, race_state.track.width, race_state.track.height)

  function press() {
    race_state.dx += 100
  }

  document.querySelector('body').addEventListener('click', press)
  document.querySelector('body').addEventListener('touchstart', press)

  async function change_car(e) {
    race_state.car = await load_img(e.target.src)
  }

  document.querySelectorAll('img').forEach(img => {
    img.addEventListener('click', change_car)
    img.addEventListener('touchstart', change_car)
  })

  function start() {
    document.querySelector('section#race').style.display = 'block'
    document.querySelector('section#start').style.display = 'none'
  }

  document.querySelector('button#start').addEventListener('click', start)
  document.querySelector('button#start').addEventListener('touchstart', start)

  main()
}

function render() {
  const canvas = document.querySelector('canvas')
  const ctx = canvas.getContext('2d')
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

  ctx.save()
  ctx.translate(50 - race_state.x,0)

  let screen = Math.floor(race_state.x / race_state.track.width)
  ctx.drawImage(race_state.track, (screen+1)*race_state.track.width, 0)

  ctx.drawImage(race_state.track, screen*race_state.track.width, 0)

  ctx.fillStyle = '#aaa'
  ctx.drawImage(race_state.car, race_state.x, race_state.y)
  ctx.restore()
}

init()

</script>

</html>