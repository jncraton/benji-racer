<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Benji Racer</title>

<style>
body {
  margin:0 auto;
  padding:0;
  width:640px;
}
canvas {
  border:1px solid #ccc;
}
</style>

</head>
<body>
<div id=log></div>
</body>

<script>
//https://jlongster.com/Making-Sprite-based-Games-with-Canvas

var race_state = {}
var imgs = {}

function get_track_top(x) {
  let track = race_state.track

  var canvas = document.createElement('canvas')
  canvas.width = track.width
  canvas.height = track.height
  canvas.getContext('2d').drawImage(track, 0, 0, track.width, track.height)

  for (var y=0; y<240; y++) {
    if (!canvas.getContext('2d').getImageData(x, y, 1, 1).data[0]) return y
  }

  return 300
}

async function load_img(filename) {
  return new Promise(resolve => {
    var img = new Image()
    img.onload = function() {
        imgs[filename] = img
        console.log(filename + ' loaded')
        resolve(img)
    }
    img.src = filename
  });
}

function update(dt) {
  race_state.x = (race_state.x + 200 * dt) % 2000

  let car_height = 32
  let car_width = 64
  let xfuzz = car_width / 4

  race_state.dy += 3
  race_state.y += race_state.dy * dt

  floor = Math.min(get_track_top(race_state.x + xfuzz) - car_height,
                   get_track_top(race_state.x + car_width - xfuzz) - car_height)

  if (race_state.y > floor) {
    race_state.dy = 50 * (floor - race_state.y)
    race_state.y = floor
  }

  document.querySelector('#log').innerHTML='<p>x:' + race_state.x +'<p>y:' + race_state.y +'<p>dy:' + race_state.dy
} 

var lastTime = Date.now();
function main() {
    var now = Date.now();
    var dt = (now - lastTime) / 1000.0;

    update(dt);
    render();

    lastTime = now;
    requestAnimationFrame(main);
};

async function init() {
  const canvas = document.createElement("canvas")
  const ctx = canvas.getContext("2d")
  canvas.width = 640
  canvas.height = 480
  ctx.scale(2,2)
  document.body.appendChild(canvas)

  race_state.x = 0
  race_state.y = 0
  race_state.dy = 0
  race_state.track = await load_img('assets/tracks/1.png')


  main()
}

function render() {
  const canvas = document.querySelector('canvas')
  const ctx = canvas.getContext('2d')
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

  ctx.save()
  ctx.translate(50 - race_state.x,0)

  ctx.drawImage(race_state.track, 0, 0)

  ctx.fillStyle = '#00f'
  ctx.fillRect(race_state.x,race_state.y,64,32)
  ctx.restore()
}

init()

</script>

</html>