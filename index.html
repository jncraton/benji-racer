<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Benji Racer</title>

<style>
body {
  margin:0 auto;
  padding:0;
  max-width:960px;
}
* {
  font:200 32px sans-serif;
  color:#222;
}
button,img {
  font-size:32px;
  border:2px solid #777;
  border-radius:7px;
  box-shadow:1px 1px 1px #777;
  padding:10px;
  margin:5px;
  max-width:80%;
}
img.selected { border:2px solid blue; }
button:hover,button:focus,img:hover,img:focus { box-shadow:2px 2px 2px; }
button { background-color:inherit; }
img { height:64px; } 
div,section { text-align:center; }
h1 { font-size:48px; }
canvas { width:100%; }
#race { display:none; }
</style>

</head>
<body>
<section id=start>
  <h1>Benji Racer</h1>
  <div>
  <h2>Cars</h2>
  <img class=car src="assets/cars/2.png">
  <img class=car src="assets/cars/3.png">
  <img class=car src="assets/cars/4.png">
  <img class=car src="assets/cars/5.png">
  <img class=car src="assets/cars/6.png">
  <img class=car src="assets/cars/7.png">
  <img class=car src="assets/cars/8.png">
  </div>

  <div>
  <h2>Tracks</h2>
  <img class=track src="assets/tracks/1.png">
  <img class=track src="assets/tracks/2.png">
  </div>

  <div>
  <h2>Music</h2>
  <audio controls src="assets/music/yuriy-bespalov---tropical-house.mp3"></audio>
  </div>
  
<div><button name=start>Start</button></div>
</section>

<section id="race">
<div><span>Coins: <span id=coins></span></span><button name=reset>New Race</button></div>
<canvas width=640 height=480></canvas>
</section>

<script>
var race_state = {}

function get_track_top(x) {
  x = x % race_state.track.width

  col = race_state.track.canvas.getContext('2d').getImageData(x, 1, 1, 240).data

  for (var y=0; y<240; y++) {
    if (col[y*4] < 240 && col[y*4 + 1] < 240 && col[y*4 + 2] < 240) return y
  }

  return 300
}

async function load_img(filename) {
  return new Promise(resolve => {
    var img = new Image()
    img.onload = function() {
        img.canvas = document.createElement('canvas')
        img.canvas.width = img.width
        img.canvas.height = img.height
        img.canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height)

        resolve(img)
    }
    img.src = filename
  });
}

function update(dt) {
  race_state.dx = Math.min(500, race_state.dx)
  race_state.x = race_state.x + race_state.dx * dt
  race_state.dx -= 30 * dt
  race_state.dx = Math.max(0, race_state.dx)

  let car_height = 32
  let car_width = 64
  let xfuzz = car_width / 4

  floor = Math.min(get_track_top(race_state.x + xfuzz) - car_height,
                   get_track_top(race_state.x + car_width - xfuzz) - car_height)

  if (race_state.y > floor) {
    race_state.dy = 50 * (floor - race_state.y) * dt
    race_state.y = floor
  } else {
    race_state.dy += 200 * dt
    race_state.y += race_state.dy * dt
  }
} 

var lastTime = Date.now();
function main() {
    var now = Date.now();
    var dt = (now - lastTime) / 1000.0;

    if (race_state.running) {
      update(dt);
      render();
    }

    lastTime = now;
    requestAnimationFrame(main);
}

function addTouchEvents(selector, cb) {
  document.querySelectorAll(selector).forEach(el => {
    el.addEventListener('click', cb)
    el.addEventListener('touchstart', cb)
  })
}

function set_race_active(state) {
  race_state.running = state
  race_state.x = 0
  race_state.y = 0
  race_state.dx = 200
  race_state.dy = 0

  document.querySelector('section#race').style.display = state ? 'block' : 'none'
  document.querySelector('section#start').style.display = state ? 'none' : 'block'
}

async function select_race_property(cls, e) {
  race_state[cls] = await load_img(e.target.src)

  document.querySelectorAll('.' + cls).forEach(e => { e.classList.remove('selected') })
  e.target.classList.add('selected')
}

async function init() {
  const ctx = document.querySelector('canvas').getContext("2d")
  ctx.scale(2,2)

  addTouchEvents('body', () => { 
    race_state.dx += 100
  })

  addTouchEvents('img.car', select_race_property.bind(null, 'car'))
  addTouchEvents('img.track', select_race_property.bind(null, 'track'))

  addTouchEvents('button[name=start]', set_race_active.bind(null, true))
  addTouchEvents('button[name=reset]', set_race_active.bind(null, false))

  main()
}

function render() {
  const ctx = document.querySelector('canvas').getContext('2d')
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

  ctx.save()
  ctx.translate(50 - race_state.x,0)

  let screen = Math.floor(race_state.x / race_state.track.width)

  ctx.drawImage(race_state.track, (screen+1)*race_state.track.width, 0)
  ctx.drawImage(race_state.track, screen*race_state.track.width, 0)

  const coin_interval = 777
  let coins = Math.floor(race_state.x / coin_interval)

  document.querySelector('#coins').textContent = coins

  let next_coin_x = (coins + 1) * coin_interval
  let next_coin_y = get_track_top(next_coin_x) - 30

  ctx.fillStyle = 'orange';
  ctx.fillRect(next_coin_x, next_coin_y, 20, 20)

  ctx.drawImage(race_state.car, race_state.x, race_state.y)

  ctx.restore()
}

init()

</script>

</html>