<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Benji Racer</title>

<style>
body {
  margin:0 auto;
  padding:0;
  max-width:960px;
}
* {
  font-family:sans-serif;
  font-weight:200;
  font-size:32px;
  color:#222;
}
h1 {
  font-size:48px;
}
div,section {
  text-align:center;
}
button,img {
  font-size:32px;
  border:2px solid #777;
  border-radius:7px;
  box-shadow:1px 1px 1px #777;
  padding:10px;
  margin:5px;
  max-width:80%;
}
img.selected {
  border:2px solid blue;
}
button:hover,button:focus,img:hover,img:focus {
  box-shadow:2px 2px 2px;
}
button {
  background-color:inherit;
}
img {
  height:64px; 
}
canvas {
  width:100%;
}
#race {
  display:none;
}
</style>

</head>
<body>
<section id=start>
  <h1>Benji Racer</h1>
  <div>
  <h2>Cars</h2>
  <img class=car src="assets/cars/2.png">
  <img class=car src="assets/cars/3.png">
  <img class=car src="assets/cars/4.png">
  <img class=car src="assets/cars/5.png">
  <img class=car src="assets/cars/6.png">
  <img class=car src="assets/cars/7.png">
  </div>

  <div>
  <h2>Tracks</h2>
  <img class=track src="assets/tracks/1.png">
  <img class=track src="assets/tracks/2.png">
  </div>

  <div>
  <h2>Music</h2>
  <audio controls src="assets/music/yuriy-bespalov---tropical-house.mp3"></audio>
  </div>
  
<div><button name=start>Start</button></div>
</section>

<section id="race">
<div><button name=reset>New Race</button></div>
<div><span>Coins: <span id=coins></span></span></div>
<canvas></canvas>
</section>

<script>
var race_state = {}
var imgs = {}

function get_track_top(x) {
  x = x % race_state.track.width

  col = race_state.track.canvas.getContext('2d').getImageData(x, 1, 1, 240).data

  for (var y=0; y<240; y++) {
    if (col[y*4] < 240 && col[y*4 + 1] < 240 && col[y*4 + 2] < 240) return y
  }

  return 300
}

async function load_img(filename) {
  return new Promise(resolve => {
    var img = new Image()
    img.onload = function() {
        imgs[filename] = img
        console.log(filename + ' loaded')

        img.canvas = document.createElement('canvas')
        img.canvas.width = img.width
        img.canvas.height = img.height
        img.canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height)

        resolve(img)
    }
    img.src = filename
  });
}

function update(dt) {
  race_state.dx = Math.min(500, race_state.dx)
  race_state.x = race_state.x + race_state.dx * dt
  race_state.dx -= 30 * dt
  race_state.dx = Math.max(0, race_state.dx)

  let car_height = 32
  let car_width = 64
  let xfuzz = car_width / 4

  floor = Math.min(get_track_top(race_state.x + xfuzz) - car_height,
                   get_track_top(race_state.x + car_width - xfuzz) - car_height)

  if (race_state.y > floor) {
    race_state.dy = 50 * (floor - race_state.y) * dt
    race_state.y = floor
  } else {
    race_state.dy += 200 * dt
    race_state.y += race_state.dy * dt
  }
} 

var lastTime = Date.now();
function main() {
    var now = Date.now();
    var dt = (now - lastTime) / 1000.0;

    update(dt);
    render();

    lastTime = now;
    requestAnimationFrame(main);
};

async function init() {
  const canvas = document.querySelector('canvas')
  const ctx = canvas.getContext("2d")
  canvas.width = 640
  canvas.height = 480
  ctx.scale(2,2)

  race_state.track = await load_img('assets/tracks/1.png')
  race_state.car = await load_img('assets/cars/2.png')

  function addTouchEvents(selector, cb) {
    document.querySelectorAll(selector).forEach(el => {
      el.addEventListener('click', cb)
      el.addEventListener('touchstart', cb)
    })
  }

  addTouchEvents('body', () => { 
    race_state.dx += 100
  })

  addTouchEvents('img.car', async (e) => {
    race_state.car = await load_img(e.target.src)

    document.querySelectorAll('.car').forEach(e => {
      e.classList.remove('selected')
    })
    e.target.classList.add('selected')
  })

  addTouchEvents('img.track', async (e) => {
    race_state.track = await load_img(e.target.src)

    document.querySelectorAll('.track').forEach(e => {
      e.classList.remove('selected')
    })
    e.target.classList.add('selected')
  })

  addTouchEvents('button[name=start]', () => {
    document.querySelector('section#race').style.display = 'block'
    document.querySelector('section#start').style.display = 'none'

    race_state.x = 0
    race_state.y = 0
    race_state.dx = 200
    race_state.dy = 0
  })

  function reset() {
    document.querySelector('section#race').style.display = 'none'
    document.querySelector('section#start').style.display = 'block'

    race_state.x = 0
    race_state.y = 0
    race_state.dx = 200
    race_state.dy = 0
  }

  addTouchEvents('button[name=reset]', reset)

  reset()
  main()
}

function render() {
  const canvas = document.querySelector('canvas')
  const ctx = canvas.getContext('2d')
  
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

  ctx.save()
  ctx.translate(50 - race_state.x,0)

  let screen = Math.floor(race_state.x / race_state.track.width)

  ctx.drawImage(race_state.track, (screen+1)*race_state.track.width, 0)
  ctx.drawImage(race_state.track, screen*race_state.track.width, 0)

  ctx.drawImage(race_state.car, race_state.x, race_state.y)
  ctx.restore()


  document.querySelector('#coins').textContent = Math.floor(race_state.x / 777)
}

init()

</script>

</html>